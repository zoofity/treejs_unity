import{V as b,T as q,M as Y,a as Q,b as ct,F as xt,R as K,L as X,B as J,c as G,d as ht,e as rt,Q as yt,f as wt,D as dt,N as $,U as bt,g as ut,G as at,O as lt,S as Mt,h as Tt,C as At,i as Et,j as mt}from"./index-25efa746.js";/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function C(D,t,e,s){function i(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function a(l){try{h(s.next(l))}catch(d){r(d)}}function n(l){try{h(s.throw(l))}catch(d){r(d)}}function h(l){l.done?o(l.value):i(l.value).then(a,n)}h((s=s.apply(D,t||[])).next())})}class tt{constructor(){this.name="",this.minZoom=0,this.maxZoom=20,this.bounds=[],this.center=[]}fetchTile(t,e,s){return null}getMetaData(){return C(this,void 0,void 0,function*(){})}}class pt extends tt{constructor(t="https://a.tile.openstreetmap.org/"){super(),this.address=t,this.format="png",this.maxZoom=19}fetchTile(t,e,s){return new Promise((i,o)=>{const r=document.createElement("img");r.onload=function(){i(r)},r.onerror=function(){o()},r.crossOrigin="Anonymous",r.src=this.address+t+"/"+e+"/"+s+"."+this.format})}}class nt{static createOffscreenCanvas(t,e){if(typeof OffscreenCanvas<"u")return new OffscreenCanvas(t,e);{let s=document.createElement("canvas");return s.width=t,s.height=e,s}}}class ft{static createFillTexture(t="#000000",e=1,s=1){const i=nt.createOffscreenCanvas(e,s),o=i.getContext("2d");o.fillStyle=t,o.fillRect(0,0,e,s);const r=new q(i);return r.format=K,r.magFilter=X,r.minFilter=X,r.generateMipmaps=!1,r.needsUpdate=!0,r}}class T{}T.root=-1;T.topLeft=0;T.topRight=1;T.bottomLeft=2;T.bottomRight=3;class H extends Y{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0,a=null,n=null){super(a,n),this.mapView=null,this.parentNode=null,this.subdivided=!1,this.disposed=!1,this.nodesLoaded=0,this.childrenCache=null,this.isMesh=!0,this.mapView=e,this.parentNode=t,this.disposed=!1,this.location=s,this.level=i,this.x=o,this.y=r,this.initialize()}initialize(){return C(this,void 0,void 0,function*(){})}createChildNodes(){}subdivide(){const t=this.mapView.maxZoom();this.children.length>0||this.level+1>t||this.parentNode!==null&&this.parentNode.nodesLoaded<H.childrens||(this.mapView.cacheTiles&&this.childrenCache!==null?(this.isMesh=!1,this.children=this.childrenCache,this.nodesLoaded=this.childrenCache.length):this.createChildNodes(),this.subdivided=!0)}simplify(){const t=this.mapView.minZoom();if(!(this.level-1<t)){if(this.mapView.cacheTiles)this.childrenCache=this.children;else for(let e=0;e<this.children.length;e++)this.children[e].dispose();this.subdivided=!1,this.isMesh=!0,this.children=[],this.nodesLoaded=0}}loadData(){return C(this,void 0,void 0,function*(){if(this.level<this.mapView.provider.minZoom||this.level>this.mapView.provider.maxZoom){console.warn("Geo-Three: Loading tile outside of provider range.",this),this.material.map=H.defaultTexture,this.material.needsUpdate=!0;return}try{const t=yield this.mapView.provider.fetchTile(this.level,this.x,this.y);if(this.disposed)return;const e=new q(t);e.generateMipmaps=!1,e.format=K,e.magFilter=X,e.minFilter=X,e.needsUpdate=!0,this.material.map=e}catch{if(this.disposed)return;console.warn("Geo-Three: Failed to load node tile data.",this),this.material.map=H.defaultTexture}this.material.needsUpdate=!0})}nodeReady(){if(this.disposed){console.warn("Geo-Three: nodeReady() called for disposed node.",this),this.dispose();return}if(this.parentNode!==null){if(this.parentNode.nodesLoaded++,this.parentNode.nodesLoaded===H.childrens){this.parentNode.subdivided===!0&&(this.parentNode.isMesh=!1);for(let t=0;t<this.parentNode.children.length;t++)this.parentNode.children[t].visible=!0}this.parentNode.nodesLoaded>H.childrens&&console.error("Geo-Three: Loaded more children objects than expected.",this.parentNode.nodesLoaded,this)}else this.visible=!0}dispose(){this.disposed=!0;const t=this;try{const e=t.material;e.dispose(),e.map&&e.map!==H.defaultTexture&&e.map.dispose()}catch{}try{t.geometry.dispose()}catch{}}}H.defaultTexture=ft.createFillTexture();H.baseGeometry=null;H.baseScale=null;H.childrens=4;class k extends J{constructor(t=1,e=1,s=1,i=1,o=!1,r=10){super();const a=[],n=[],h=[],l=[];k.buildPlane(t,e,s,i,a,n,h,l),o&&k.buildSkirt(t,e,s,i,r,a,n,h,l),this.setIndex(a),this.setAttribute("position",new G(n,3)),this.setAttribute("normal",new G(h,3)),this.setAttribute("uv",new G(l,2))}static buildPlane(t=1,e=1,s=1,i=1,o,r,a,n){const h=t/2,l=e/2,d=s+1,p=i+1,f=t/s,x=e/i;for(let v=0;v<p;v++){const m=v*x-l;for(let y=0;y<d;y++){const c=y*f-h;r.push(c,0,m),a.push(0,1,0),n.push(y/s,1-v/i)}}for(let v=0;v<i;v++)for(let m=0;m<s;m++){const y=m+d*v,c=m+d*(v+1),u=m+1+d*(v+1),g=m+1+d*v;o.push(y,c,g,c,u,g)}}static buildSkirt(t=1,e=1,s=1,i=1,o,r,a,n,h){const l=t/2,d=e/2,p=s+1,f=i+1,x=t/s,v=e/i;let m=a.length/3;for(let c=0;c<p;c++){const u=c*x-l,g=-d;a.push(u,-o,g),n.push(0,1,0),h.push(c/s,1)}for(let c=0;c<s;c++){const u=c,g=c+1,w=c+m,I=c+m+1;r.push(g,w,u,g,I,w)}m=a.length/3;for(let c=0;c<p;c++){const u=c*x-l,g=i*v-d;a.push(u,-o,g),n.push(0,1,0),h.push(c/s,0)}let y=p*f-s-1;for(let c=0;c<s;c++){const u=y+c,g=y+c+1,w=c+m,I=c+m+1;r.push(u,w,g,w,I,g)}m=a.length/3;for(let c=0;c<f;c++){const u=c*v-d,g=-l;a.push(g,-o,u),n.push(0,1,0),h.push(0,1-c/i)}for(let c=0;c<i;c++){const u=c*f,g=(c+1)*f,w=c+m,I=c+m+1;r.push(u,w,g,w,I,g)}m=a.length/3;for(let c=0;c<f;c++){const u=c*v-d,g=s*x-l;a.push(g,-o,u),n.push(0,1,0),h.push(1,1-c/i)}for(let c=0;c<i;c++){const u=c*f+i,g=(c+1)*f+i,w=c+m,I=c+m+1;r.push(g,w,u,g,I,w)}}}class it{constructor(t,e){this.latitude=t,this.longitude=e}}class E{static datumsToSpherical(t,e){const s=e*E.EARTH_ORIGIN/180;let i=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return i=i*E.EARTH_ORIGIN/180,new ht(s,i)}static sphericalToDatums(t,e){const s=t/E.EARTH_ORIGIN*180;let i=e/E.EARTH_ORIGIN*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),new it(i,s)}static quadtreeToDatums(t,e,s){const i=Math.pow(2,t),o=e/i*360-180,a=180*(Math.atan(Math.sinh(Math.PI*(1-2*s/i)))/Math.PI);return new it(a,o)}static vectorToDatums(t){const e=180/Math.PI,s=Math.atan2(t.y,Math.sqrt(Math.pow(t.x,2)+Math.pow(-t.z,2)))*e,i=Math.atan2(-t.z,t.x)*e;return new it(s,i)}static datumsToVector(t,e){const s=Math.PI/180,i=e*s,o=t*s;var r=Math.cos(o);return new b(-Math.cos(i+Math.PI)*r,Math.sin(o),Math.sin(i+Math.PI)*r)}static mapboxAltitude(t){return(t.r*255*65536+t.g*255*256+t.b*255)*.1-1e4}}E.EARTH_RADIUS=6371008;E.EARTH_RADIUS_A=6378137;E.EARTH_RADIUS_B=6356752314245e-6;E.EARTH_PERIMETER=2*Math.PI*E.EARTH_RADIUS;E.EARTH_ORIGIN=E.EARTH_PERIMETER/2;class F extends H{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0){super(t,e,s,i,o,r,F.geometry,new Q({wireframe:!1})),this.matrixAutoUpdate=!1,this.isMesh=!0,this.visible=!1}initialize(){const t=Object.create(null,{initialize:{get:()=>super.initialize}});return C(this,void 0,void 0,function*(){t.initialize.call(this),yield this.loadData(),this.nodeReady()})}createChildNodes(){const t=this.level+1,e=this.x*2,s=this.y*2,i=Object.getPrototypeOf(this).constructor;let o=new i(this,this.mapView,T.topLeft,t,e,s);o.scale.set(.5,1,.5),o.position.set(-.25,0,-.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new i(this,this.mapView,T.topRight,t,e+1,s),o.scale.set(.5,1,.5),o.position.set(.25,0,-.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new i(this,this.mapView,T.bottomLeft,t,e,s+1),o.scale.set(.5,1,.5),o.position.set(-.25,0,.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new i(this,this.mapView,T.bottomRight,t,e+1,s+1),o.scale.set(.5,1,.5),o.position.set(.25,0,.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0)}raycast(t,e){this.isMesh===!0&&super.raycast(t,e)}}F.geometry=new k(1,1,1,1,!1);F.baseGeometry=F.geometry;F.baseScale=new b(E.EARTH_PERIMETER,1,E.EARTH_PERIMETER);class It extends J{constructor(t=1,e=1,s=1,i=1,o=!1,r=10,a=null,n=!0){super();const h=[],l=[],d=[],p=[];k.buildPlane(t,e,s,i,h,l,d,p);const f=a.data;for(let x=0,v=0;x<f.length&&v<l.length;x+=4,v+=3){const m=f[x],y=f[x+1],c=f[x+2],u=(m*65536+y*256+c)*.1-1e4;l[v+1]=u}o&&k.buildSkirt(t,e,s,i,r,h,l,d,p),this.setIndex(h),this.setAttribute("position",new G(l,3)),this.setAttribute("normal",new G(d,3)),this.setAttribute("uv",new G(p,2)),n&&this.computeNormals(s,i)}computeNormals(t,e){const s=this.getAttribute("position");if(s!==void 0){let i=this.getAttribute("normal");const o=e*t;for(let v=0;v<o;v++)i.setXYZ(v,0,0,0);const r=new b,a=new b,n=new b,h=new b,l=new b,d=new b,p=new b,f=new b,x=e*t*6;for(let v=0;v<x;v+=3){const m=this.index.getX(v+0),y=this.index.getX(v+1),c=this.index.getX(v+2);r.fromBufferAttribute(s,m),a.fromBufferAttribute(s,y),n.fromBufferAttribute(s,c),p.subVectors(n,a),f.subVectors(r,a),p.cross(f),h.fromBufferAttribute(i,m),l.fromBufferAttribute(i,y),d.fromBufferAttribute(i,c),h.add(p),l.add(p),d.add(p),i.setXYZ(m,h.x,h.y,h.z),i.setXYZ(y,l.x,l.y,l.z),i.setXYZ(c,d.x,d.y,d.z)}this.normalizeNormals(),i.needsUpdate=!0}}}class j extends H{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0,a=j.geometry,n=new rt({wireframe:!1,color:16777215})){super(t,e,s,i,o,r,a,n),this.heightLoaded=!1,this.textureLoaded=!1,this.geometrySize=16,this.geometryNormals=!1,this.isMesh=!0,this.visible=!1,this.matrixAutoUpdate=!1}initialize(){const t=Object.create(null,{initialize:{get:()=>super.initialize}});return C(this,void 0,void 0,function*(){t.initialize.call(this),yield this.loadData(),yield this.loadHeightGeometry(),this.nodeReady()})}loadData(){const t=Object.create(null,{loadData:{get:()=>super.loadData}});return C(this,void 0,void 0,function*(){yield t.loadData.call(this),this.textureLoaded=!0})}loadHeightGeometry(){return C(this,void 0,void 0,function*(){if(this.mapView.heightProvider===null)throw new Error("GeoThree: MapView.heightProvider provider is null.");if(this.level<this.mapView.heightProvider.minZoom||this.level>this.mapView.heightProvider.maxZoom){console.warn("Geo-Three: Loading tile outside of provider range.",this),this.geometry=F.baseGeometry;return}try{const t=yield this.mapView.heightProvider.fetchTile(this.level,this.x,this.y);if(this.disposed)return;const e=nt.createOffscreenCanvas(this.geometrySize+1,this.geometrySize+1),s=e.getContext("2d");s.imageSmoothingEnabled=!1,s.drawImage(t,0,0,j.tileSize,j.tileSize,0,0,e.width,e.height);const i=s.getImageData(0,0,e.width,e.height);this.geometry=new It(1,1,this.geometrySize,this.geometrySize,!0,10,i,!0)}catch{if(this.disposed)return;this.geometry=F.baseGeometry}this.heightLoaded=!0})}createChildNodes(){const t=this.level+1,e=Object.getPrototypeOf(this).constructor,s=this.x*2,i=this.y*2;let o=new e(this,this.mapView,T.topLeft,t,s,i);o.scale.set(.5,1,.5),o.position.set(-.25,0,-.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new e(this,this.mapView,T.topRight,t,s+1,i),o.scale.set(.5,1,.5),o.position.set(.25,0,-.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new e(this,this.mapView,T.bottomLeft,t,s,i+1),o.scale.set(.5,1,.5),o.position.set(-.25,0,.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0),o=new e(this,this.mapView,T.bottomRight,t,s+1,i+1),o.scale.set(.5,1,.5),o.position.set(.25,0,.25),this.add(o),o.updateMatrix(),o.updateMatrixWorld(!0)}raycast(t,e){this.isMesh===!0&&super.raycast(t,e)}}j.tileSize=256;j.geometry=new k(1,1,1,1);j.baseGeometry=F.geometry;j.baseScale=new b(E.EARTH_PERIMETER,1,E.EARTH_PERIMETER);class vt extends J{constructor(t,e,s,i,o,r,a){super();const n=r+a;let h=0;const l=[],d=new b,p=new b,f=[],x=[],v=[],m=[];for(let y=0;y<=s;y++){const c=[],u=y/s;for(let g=0;g<=e;g++){const w=g/e;d.x=-t*Math.cos(i+w*o)*Math.sin(r+u*a),d.y=t*Math.cos(r+u*a),d.z=t*Math.sin(i+w*o)*Math.sin(r+u*a),x.push(d.x,d.y,d.z),p.set(d.x,d.y,d.z).normalize(),v.push(p.x,p.y,p.z),m.push(w,1-u),c.push(h++)}l.push(c)}for(let y=0;y<s;y++)for(let c=0;c<e;c++){const u=l[y][c+1],g=l[y][c],w=l[y+1][c],I=l[y+1][c+1];(y!==0||r>0)&&f.push(u,g,I),(y!==s-1||n<Math.PI)&&f.push(g,w,I)}this.setIndex(f),this.setAttribute("position",new G(x,3)),this.setAttribute("normal",new G(v,3)),this.setAttribute("uv",new G(m,2))}}class B extends H{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0){super(t,e,s,i,o,r,B.createGeometry(i,o,r),new Q({wireframe:!1})),this.applyScaleNode(),this.matrixAutoUpdate=!1,this.isMesh=!0,this.visible=!1}initialize(){const t=Object.create(null,{initialize:{get:()=>super.initialize}});return C(this,void 0,void 0,function*(){t.initialize.call(this),yield this.loadData(),this.nodeReady()})}static createGeometry(t,e,s){const i=Math.pow(2,t),o=40,r=Math.floor(B.segments*(o/(t+1))/o),a=1/i*2*Math.PI,n=e*a,h=1/i*Math.PI,l=s*h;return new vt(1,r,r,n,a,l,h)}applyScaleNode(){this.geometry.computeBoundingBox();const e=this.geometry.boundingBox.clone().getCenter(new b),s=new ct;s.compose(new b(-e.x,-e.y,-e.z),new yt,new b(E.EARTH_RADIUS,E.EARTH_RADIUS,E.EARTH_RADIUS)),this.geometry.applyMatrix4(s),this.position.copy(e),this.updateMatrix(),this.updateMatrixWorld()}updateMatrix(){this.matrix.setPosition(this.position),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t=!1){(this.matrixWorldNeedsUpdate||t)&&(this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1)}createChildNodes(){const t=this.level+1,e=this.x*2,s=this.y*2,i=Object.getPrototypeOf(this).constructor;let o=new i(this,this.mapView,T.topLeft,t,e,s);this.add(o),o=new i(this,this.mapView,T.topRight,t,e+1,s),this.add(o),o=new i(this,this.mapView,T.bottomLeft,t,e,s+1),this.add(o),o=new i(this,this.mapView,T.bottomRight,t,e+1,s+1),this.add(o)}raycast(t,e){this.isMesh===!0&&super.raycast(t,e)}}B.baseGeometry=new vt(E.EARTH_RADIUS,64,64,0,2*Math.PI,0,Math.PI);B.baseScale=new b(1,1,1);B.segments=80;class O extends j{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0){const a=O.prepareMaterial(new rt({map:H.defaultTexture,color:16777215}));super(t,e,s,i,o,r,O.geometry,a),this.frustumCulled=!1}static prepareMaterial(t){return t.userData={heightMap:{value:O.defaultHeightTexture}},t.onBeforeCompile=e=>{for(const s in t.userData)e.uniforms[s]=t.userData[s];e.vertexShader=`
			uniform sampler2D heightMap;
			`+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <fog_vertex>",`
			#include <fog_vertex>
	
			// Calculate height of the title
			vec4 _theight = texture2D(heightMap, vUv);
			float _height = ((_theight.r * 255.0 * 65536.0 + _theight.g * 255.0 * 256.0 + _theight.b * 255.0) * 0.1) - 10000.0;
			vec3 _transformed = position + _height * normal;
	
			// Vertex position based on height
			gl_Position = projectionMatrix * modelViewMatrix * vec4(_transformed, 1.0);
			`)},t}loadData(){const t=Object.create(null,{loadData:{get:()=>super.loadData}});return C(this,void 0,void 0,function*(){yield t.loadData.call(this),this.textureLoaded=!0})}loadHeightGeometry(){return C(this,void 0,void 0,function*(){if(this.mapView.heightProvider===null)throw new Error("GeoThree: MapView.heightProvider provider is null.");if(this.level<this.mapView.heightProvider.minZoom||this.level>this.mapView.heightProvider.maxZoom){console.warn("Geo-Three: Loading tile outside of provider range.",this),this.material.map=O.defaultTexture,this.material.needsUpdate=!0;return}try{const t=yield this.mapView.heightProvider.fetchTile(this.level,this.x,this.y);if(this.disposed)return;const e=new q(t);e.generateMipmaps=!1,e.format=K,e.magFilter=$,e.minFilter=$,e.needsUpdate=!0,this.material.userData.heightMap.value=e}catch{if(this.disposed)return;console.error("Geo-Three: Failed to load node tile height data.",this),this.material.userData.heightMap.value=O.defaultHeightTexture}this.material.needsUpdate=!0,this.heightLoaded=!0})}raycast(t,e){this.isMesh===!0&&(this.geometry=F.geometry,super.raycast(t,e),this.geometry=O.geometry)}dispose(){super.dispose(),this.material.userData.heightMap.value&&this.material.userData.heightMap.value!==O.defaultHeightTexture&&this.material.userData.heightMap.value.dispose()}}O.defaultHeightTexture=ft.createFillTexture("#0186C0");O.geometrySize=256;O.geometry=new k(1,1,O.geometrySize,O.geometrySize,!0);O.baseGeometry=F.geometry;O.baseScale=new b(E.EARTH_PERIMETER,1,E.EARTH_PERIMETER);class Rt{constructor(){this.subdivisionRays=1,this.thresholdUp=.6,this.thresholdDown=.15,this.raycaster=new wt,this.mouse=new ht,this.powerDistance=!1,this.scaleDistance=!0}updateLOD(t,e,s,i){const o=[];for(let r=0;r<this.subdivisionRays;r++)this.mouse.set(Math.random()*2-1,Math.random()*2-1),this.raycaster.setFromCamera(this.mouse,e),this.raycaster.intersectObjects(t.children,!0,o);for(let r=0;r<o.length;r++){const a=o[r].object;let n=o[r].distance;if(this.powerDistance&&(n=Math.pow(n*2,a.level)),this.scaleDistance){const h=a.matrixWorld.elements;n=new b(h[0],h[1],h[2]).length()/n}n>this.thresholdUp?a.subdivide():n<this.thresholdDown&&a.parentNode&&a.parentNode.simplify()}}}class Dt{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(this.numTriangles*4);for(let s=0;s<this.numTriangles;s++){let i=s+2,o=0,r=0,a=0,n=0,h=0,l=0;for(i&1?a=n=h=e:o=r=l=e;(i>>=1)>1;){const p=o+a>>1,f=r+n>>1;i&1?(a=o,n=r,o=h,r=l):(o=a,r=n,a=h,n=l),h=p,l=f}const d=s*4;this.coords[d+0]=o,this.coords[d+1]=r,this.coords[d+2]=a,this.coords[d+3]=n}}createTile(t){return new zt(t,this)}}class zt{constructor(t,e){const s=e.gridSize;if(t.length!==s*s)throw new Error(`Expected terrain data of length ${s*s} (${s} x ${s}), got ${t.length}.`);this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:s,gridSize:i}=this.martini,{terrain:o,errors:r}=this;for(let a=t-1;a>=0;a--){const n=a*4,h=s[n+0],l=s[n+1],d=s[n+2],p=s[n+3],f=h+d>>1,x=l+p>>1,v=f+x-l,m=x+h-f,y=(o[l*i+h]+o[p*i+d])/2,c=x*i+f,u=Math.abs(y-o[c]);if(r[c]=Math.max(r[c],u),a<e){const g=(l+m>>1)*i+(h+v>>1),w=(p+m>>1)*i+(d+v>>1);r[c]=Math.max(r[c],r[g],r[w])}}}getMesh(t=0,e=!1){const{gridSize:s,indices:i}=this.martini,{errors:o}=this;let r=0,a=0;const n=s-1;let h,l,d=0;const p=[],f=[],x=[],v=[];i.fill(0);function m(R,z,M,A,P,S){const U=R+M>>1,N=z+A>>1;Math.abs(R-P)+Math.abs(z-S)>1&&o[N*s+U]>t?(m(P,S,R,z,U,N),m(M,A,P,S,U,N)):(h=z*s+R,l=A*s+M,d=S*s+P,i[h]===0&&(e&&(R===0?p.push(r):R===n&&f.push(r),z===0?x.push(r):z===n&&v.push(r)),i[h]=++r),i[l]===0&&(e&&(M===0?p.push(r):M===n&&f.push(r),A===0?x.push(r):A===n&&v.push(r)),i[l]=++r),i[d]===0&&(e&&(P===0?p.push(r):P===n&&f.push(r),S===0?x.push(r):S===n&&v.push(r)),i[d]=++r),a++)}m(0,0,n,n,n,0),m(n,n,0,0,0,n);let y=r*2,c=a*3;e&&(y+=(p.length+f.length+x.length+v.length)*2,c+=((p.length-1)*2+(f.length-1)*2+(x.length-1)*2+(v.length-1)*2)*3);const u=new Uint16Array(y),g=new Uint32Array(c);let w=0;function I(R,z,M,A,P,S){const U=R+M>>1,N=z+A>>1;if(Math.abs(R-P)+Math.abs(z-S)>1&&o[N*s+U]>t)I(P,S,R,z,U,N),I(M,A,P,S,U,N);else{const _=i[z*s+R]-1,et=i[A*s+M]-1,st=i[S*s+P]-1;u[2*_]=R,u[2*_+1]=z,u[2*et]=M,u[2*et+1]=A,u[2*st]=P,u[2*st+1]=S,g[w++]=_,g[w++]=et,g[w++]=st}}if(I(0,0,n,n,n,0),I(n,n,0,0,0,n),e){let z=function(M){const A=M.length;for(let P=0;P<A-1;P++){const S=M[P],U=M[P+1],N=R/2,_=(R+2)/2;u[R++]=u[2*S],u[R++]=u[2*S+1],g[w++]=S,g[w++]=N,g[w++]=U,g[w++]=N,g[w++]=_,g[w++]=U}u[R++]=u[2*M[A-1]],u[R++]=u[2*M[A-1]+1]};p.sort((M,A)=>u[2*M+1]-u[2*A+1]),f.sort((M,A)=>u[2*A+1]-u[2*M+1]),x.sort((M,A)=>u[2*A]-u[2*M]),v.sort((M,A)=>u[2*M]-u[2*A]);let R=r*2;z(p),z(f),z(x),z(v)}return{vertices:u,triangles:g,numVerticesWithoutSkirts:r}}}class V extends j{constructor(t=null,e=null,s=T.root,i=0,o=0,r=0,{elevationDecoder:a=null,meshMaxError:n=10,exageration:h=1}={}){super(t,e,s,i,o,r,V.geometry,V.prepareMaterial(new rt({map:V.emptyTexture,color:16777215,side:dt}),i,h)),this.elevationDecoder={rScaler:256,gScaler:1,bScaler:1/256,offset:-32768},this.exageration=1,this.meshMaxError=10,a&&(this.elevationDecoder=a),this.meshMaxError=n,this.exageration=h,this.frustumCulled=!1}static prepareMaterial(t,e,s=1){return t.userData={heightMap:{value:V.emptyTexture},drawNormals:{value:0},drawBlack:{value:0},zoomlevel:{value:e},computeNormals:{value:1},drawTexture:{value:1}},t.onBeforeCompile=i=>{for(let o in t.userData)i.uniforms[o]=t.userData[o];i.vertexShader=`
				uniform bool computeNormals;
				uniform float zoomlevel;
				uniform sampler2D heightMap;
				`+i.vertexShader,i.fragmentShader=`
				uniform bool drawNormals;
				uniform bool drawTexture;
				uniform bool drawBlack;
				`+i.fragmentShader,i.fragmentShader=i.fragmentShader.replace("#include <dithering_fragment>",`
				if(drawBlack) {
					gl_FragColor = vec4( 0.0,0.0,0.0, 1.0 );
				} else if(drawNormals) {
					gl_FragColor = vec4( ( 0.5 * vNormal + 0.5 ), 1.0 );
				} else if (!drawTexture) {
					gl_FragColor = vec4( 0.0,0.0,0.0, 0.0 );
				}`),i.vertexShader=i.vertexShader.replace("#include <fog_vertex>",`
				#include <fog_vertex>

				// queried pixels:
				// +-----------+
				// |   |   |   |
				// | a | b | c |
				// |   |   |   |
				// +-----------+
				// |   |   |   |
				// | d | e | f |
				// |   |   |   |
				// +-----------+
				// |   |   |   |
				// | g | h | i |
				// |   |   |   |
				// +-----------+

				if (computeNormals) {
					float e = getElevation(vUv, 0.0);
					ivec2 size = textureSize(heightMap, 0);
					float offset = 1.0 / float(size.x);
					float a = getElevation(vUv + vec2(-offset, -offset), 0.0);
					float b = getElevation(vUv + vec2(0, -offset), 0.0);
					float c = getElevation(vUv + vec2(offset, -offset), 0.0);
					float d = getElevation(vUv + vec2(-offset, 0), 0.0);
					float f = getElevation(vUv + vec2(offset, 0), 0.0);
					float g = getElevation(vUv + vec2(-offset, offset), 0.0);
					float h = getElevation(vUv + vec2(0, offset), 0.0);
					float i = getElevation(vUv + vec2(offset,offset), 0.0);


					float normalLength = 500.0 / zoomlevel;

					vec3 v0 = vec3(0.0, 0.0, 0.0);
					vec3 v1 = vec3(0.0, normalLength, 0.0);
					vec3 v2 = vec3(normalLength, 0.0, 0.0);
					v0.z = (e + d + g + h) / 4.0;
					v1.z = (e+ b + a + d) / 4.0;
					v2.z = (e+ h + i + f) / 4.0;
					vNormal = (normalize(cross(v2 - v0, v1 - v0))).rbg;
				}
				`)},t}static getTerrain(t,e,s){const{rScaler:i,bScaler:o,gScaler:r,offset:a}=s,n=e+1,h=new Float32Array(n*n);for(let l=0,d=0;d<e;d++)for(let p=0;p<e;p++,l++){const f=l*4,x=t[f+0],v=t[f+1],m=t[f+2];h[l+d]=x*i+v*r+m*o+a}for(let l=n*(n-1),d=0;d<n-1;d++,l++)h[l]=h[l-n];for(let l=n-1,d=0;d<n;d++,l+=n)h[l]=h[l-1];return h}static getMeshAttributes(t,e,s,i,o){const r=s+1,a=t.length/2,n=new Float32Array(a*3),h=new Float32Array(a*2),[l,d,p,f]=i||[0,0,s,s],x=(p-l)/s,v=(f-d)/s;for(let m=0;m<a;m++){const y=t[m*2],c=t[m*2+1],u=c*r+y;n[3*m+0]=y*x+l,n[3*m+1]=-e[u]*o,n[3*m+2]=-c*v+f,h[2*m+0]=y/s,h[2*m+1]=c/s}return{position:{value:n,size:3},uv:{value:h,size:2}}}processHeight(t){return C(this,void 0,void 0,function*(){const e=t.width,s=e+1;var i=nt.createOffscreenCanvas(e,e),o=i.getContext("2d");o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,e,e,0,0,i.width,i.height);var r=o.getImageData(0,0,i.width,i.height),a=r.data;const n=V.getTerrain(a,e,this.elevationDecoder),l=new Dt(s).createTile(n),{vertices:d,triangles:p}=l.getMesh(typeof this.meshMaxError=="function"?this.meshMaxError(this.level):this.meshMaxError),f=V.getMeshAttributes(d,n,e,[-.5,-.5,.5,.5],this.exageration);this.geometry=new J,this.geometry.setIndex(new bt(p,1)),this.geometry.setAttribute("position",new G(f.position.value,f.position.size)),this.geometry.setAttribute("uv",new G(f.uv.value,f.uv.size)),this.geometry.rotateX(Math.PI);var x=new q(t);x.generateMipmaps=!1,x.format=K,x.magFilter=$,x.minFilter=$,x.needsUpdate=!0,this.material.userData.heightMap.value=x,this.material.map=x,this.material.needsUpdate=!0})}loadHeightGeometry(){return C(this,void 0,void 0,function*(){if(this.mapView.heightProvider===null)throw new Error("GeoThree: MapView.heightProvider provider is null.");const t=yield this.mapView.heightProvider.fetchTile(this.level,this.x,this.y);this.disposed||(this.processHeight(t),this.heightLoaded=!0,this.nodeReady())})}}V.geometrySize=16;V.emptyTexture=new q;V.geometry=new k(1,1,1,1);V.tileSize=256;class L extends Y{constructor(t=L.PLANAR,e=new pt,s=null){super(void 0,new Q({transparent:!0,opacity:0})),this.lod=null,this.provider=null,this.heightProvider=null,this.root=null,this.cacheTiles=!1,this.onBeforeRender=(i,o,r,a,n,h)=>{this.lod.updateLOD(this,r,i,o)},this.lod=new Rt,this.provider=e,this.heightProvider=s,this.setRoot(t),this.preSubdivide()}setRoot(t){if(typeof t=="number"){if(!L.mapModes.has(t))throw new Error("Map mode "+t+" does is not registered.");const e=L.mapModes.get(t);t=new e(null,this)}this.root!==null&&(this.remove(this.root),this.root=null),this.root=t,this.root!==null&&(this.geometry=this.root.constructor.baseGeometry,this.scale.copy(this.root.constructor.baseScale),this.root.mapView=this,this.add(this.root),this.root.initialize())}preSubdivide(){var t,e;function s(o,r){if(!(r<=0)){o.subdivide();for(let a=0;a<o.children.length;a++)if(o.children[a]instanceof H){const n=o.children[a];s(n,r-1)}}}const i=Math.max(this.provider.minZoom,(e=(t=this.heightProvider)===null||t===void 0?void 0:t.minZoom)!==null&&e!==void 0?e:-1/0);i>0&&s(this.root,i)}setProvider(t){t!==this.provider&&(this.provider=t,this.clear())}setHeightProvider(t){t!==this.heightProvider&&(this.heightProvider=t,this.clear())}clear(){return this.traverse(function(t){t.childrenCache&&(t.childrenCache=null),t.initialize&&t.initialize()}),this}minZoom(){var t,e;return Math.max(this.provider.minZoom,(e=(t=this.heightProvider)===null||t===void 0?void 0:t.minZoom)!==null&&e!==void 0?e:-1/0)}maxZoom(){var t,e;return Math.min(this.provider.maxZoom,(e=(t=this.heightProvider)===null||t===void 0?void 0:t.maxZoom)!==null&&e!==void 0?e:1/0)}getMetaData(){this.provider.getMetaData()}raycast(t,e){return!1}}L.PLANAR=200;L.SPHERICAL=201;L.HEIGHT=202;L.HEIGHT_SHADER=203;L.MARTINI=204;L.mapModes=new Map([[L.PLANAR,F],[L.SPHERICAL,B],[L.HEIGHT,j],[L.HEIGHT_SHADER,O],[L.MARTINI,V]]);new b;new b;new ct;new b;new xt;new b;class gt{static get(t){return C(this,void 0,void 0,function*(){return new Promise(function(e,s){const i=new XMLHttpRequest;i.overrideMimeType("text/plain"),i.open("GET",t,!0),i.onload=function(){e(i.response)},i.onerror=s,i.send(null)})})}static getRaw(t){return C(this,void 0,void 0,function*(){return new Promise(function(e,s){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",t,!0),i.onload=function(){e(i.response)},i.onerror=s,i.send(null)})})}static request(t,e,s,i,o,r,a){function n(l){try{return JSON.parse(l)}catch{return l}}const h=new XMLHttpRequest;if(h.overrideMimeType("text/plain"),h.open(e,t,!0),s!=null)for(const l in s)h.setRequestHeader(l,s[l]);return o!==void 0&&(h.onload=function(l){o(n(h.response),h)}),r!==void 0&&(h.onerror=r),a!==void 0&&(h.onprogress=a),h.send(i!==void 0?i:null),h}}class W extends tt{constructor(t="",e=W.AERIAL){super(),this.maxZoom=19,this.minZoom=1,this.format="jpeg",this.mapSize=512,this.subdomain="t1",this.meta=null,this.apiKey=t,this.type=e}getMetaData(){return C(this,void 0,void 0,function*(){const t=W.ADDRESS+"/REST/V1/Imagery/Metadata/RoadOnDemand?output=json&include=ImageryProviders&key="+this.apiKey,e=yield gt.get(t);this.meta=JSON.parse(e)})}static quadKey(t,e,s){let i="";for(let o=t;o>0;o--){const r=1<<o-1;let a=0;e&r&&a++,s&r&&(a+=2),i+=a}return i}fetchTile(t,e,s){return new Promise((i,o)=>{const r=document.createElement("img");r.onload=function(){i(r)},r.onerror=function(){o()},r.crossOrigin="Anonymous",r.src="http://ecn."+this.subdomain+".tiles.virtualearth.net/tiles/"+this.type+W.quadKey(t,e,s)+".jpeg?g=1173"})}}W.ADDRESS="https://dev.virtualearth.net";W.AERIAL="a";W.ROAD="r";W.AERIAL_LABELS="h";W.OBLIQUE="o";W.OBLIQUE_LABELS="b";class Pt extends tt{constructor(t="",e="",s="base",i="normal.day",o="png",r=512){super(),this.appId=t,this.appCode=e,this.style=s,this.scheme=i,this.format=o,this.size=r,this.version="newest",this.server=1}nextServer(){this.server=this.server%4===0?1:this.server+1}getMetaData(){return C(this,void 0,void 0,function*(){})}fetchTile(t,e,s){return this.nextServer(),new Promise((i,o)=>{const r=document.createElement("img");r.onload=function(){i(r)},r.onerror=function(){o()},r.crossOrigin="Anonymous",r.src="https://"+this.server+"."+this.style+".maps.api.here.com/maptile/2.1/maptile/"+this.version+"/"+this.scheme+"/"+t+"/"+e+"/"+s+"/"+this.size+"/"+this.format+"?app_id="+this.appId+"&app_code="+this.appCode})}}Pt.PATH="/maptile/2.1/";class Z extends tt{constructor(t="",e="",s=Z.STYLE,i="png",o=!1,r="v4"){super(),this.apiToken=t,this.format=i,this.useHDPI=o,this.mode=s,this.mapId=e,this.style=e,this.version=r}getMetaData(){return C(this,void 0,void 0,function*(){const t=Z.ADDRESS+this.version+"/"+this.mapId+".json?access_token="+this.apiToken,e=yield gt.get(t),s=JSON.parse(e);this.name=s.name,this.minZoom=s.minZoom,this.maxZoom=s.maxZoom,this.bounds=s.bounds,this.center=s.center})}fetchTile(t,e,s){return new Promise((i,o)=>{const r=document.createElement("img");r.onload=function(){i(r)},r.onerror=function(){o()},r.crossOrigin="Anonymous",this.mode===Z.STYLE?r.src=Z.ADDRESS+"styles/v1/"+this.style+"/tiles/"+t+"/"+e+"/"+s+(this.useHDPI?"@2x?access_token=":"?access_token=")+this.apiToken:r.src=Z.ADDRESS+"v4/"+this.mapId+"/"+t+"/"+e+"/"+s+(this.useHDPI?"@2x.":".")+this.format+"?access_token="+this.apiToken})}}Z.ADDRESS="https://api.mapbox.com/";Z.STYLE=100;Z.MAP_ID=101;function ot(D,t){const e=t/180*.5;let s=Math.log(Math.tan((90+D)*Math.PI/360))/(Math.PI/180);return s=s/180,s=s*-.5,new b(e,0,s)}class Lt extends ut{onEnable(){const t=new pt,e=new L(L.PLANAR,t);this.mapObject=e,this.mapObject.scale.set(1,1,1),this.gameObject.add(this.mapObject)}update(){var t;(t=this.mapObject)==null||t.traverse(e=>{e instanceof Y&&(e.material.depthWrite=!1)})}}class Ct extends ut{constructor(){super(...arguments),this.currentWatchId=void 0,this.cameraWp=new b,this.objectWp=new b}template(){return`
        <div id="map-ui">
            <button id="locate" style="font-size:2em;">Locate me</button><br/>
            <form id="search"><input type="text" id="searchInfo" placeholder="Enter location"><input type="submit" value="Find"/></form><br/>
            <p id="status"></p>
            <a id="map-link" target="_blank"></a>
        </div>
    `}style(){return`
        #map-ui {
            position: absolute; 
            left: 10px; 
            top: 10px; 
            z-index: 1000;
        }

        #status, #map-link {
            font-size: 1em;
            font-family: monospace;
        }

        #map-ui button {
            font-size: 2em;
            border-radius: 10px;
            outline: none;
            border: 0;
            background: #fff;
            transition: transform 0.2s;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        #map-ui button:hover {
            transform: scale(1.05);
        }
    `}onEnable(){var e,s;const t=document.createElement("template");t.innerHTML=this.template(),this.element=t.content.firstElementChild.cloneNode(!0),document.body.prepend(this.element),this.styleElement=document.createElement("style"),this.styleElement.innerHTML=this.style(),this.element.prepend(this.styleElement),(e=this.element.querySelector("#locate"))==null||e.addEventListener("click",this.geoFindMe.bind(this)),(s=this.element.querySelector("#search"))==null||s.addEventListener("submit",this.searchLocation.bind(this))}onDisable(){var t,e;(t=this.element)==null||t.remove(),(e=this.styleElement)==null||e.remove()}async searchLocation(t){var y,c,u;t.preventDefault(),this.currentWatchId!==void 0&&(navigator.geolocation.clearWatch(this.currentWatchId),this.currentWatchId=void 0);const e=((y=this.element)==null?void 0:y.querySelector("#searchInfo")).value;if(!e)return;const i=await(await fetch(`https://nominatim.openstreetmap.org/search?q=${e}&format=jsonv2&polygon_geojson=1`)).json();if(!i||!i.length)return;let o=i.find(g=>{var w;return((w=g.geojson)==null?void 0:w.type)==="Polygon"});o||(o=i[0],console.log("no polygon found, using first result",i));const r=at.findObjectOfType(lt);if(!r)return;const a=parseFloat(o.lat),n=parseFloat(o.lon),h=ot(a,n);this.gameObject.position.copy(h);let l;if(o.geojson.type==="Polygon"){const g=new Mt,w=[];for(const I of o.geojson.coordinates[0]){const R=ot(I[1],I[0]);w.push(R)}g.moveTo(w[0].x,w[0].z);for(const I of w)g.lineTo(I.x,I.z);g.lineTo(w[0].x,w[0].z),l=new Tt(g)}else l=new At(1e-4*10,32);const d=new Q({color:255,side:dt,opacity:.1,transparent:!0}),p=new Y(l,d);p.rotateX(Math.PI/2),p.position.y=0,o.geojson.type!=="Polygon"&&(p.position.copy(h),p.scale.z=.001),this.gameObject.parent.add(p),this.lastMesh&&(this.lastMesh.geometry.dispose(),Array.isArray(this.lastMesh.material)?this.lastMesh.material.forEach(g=>g.dispose()):(c=this.lastMesh.material)==null||c.dispose(),(u=this.lastMesh.parent)==null||u.remove(this.lastMesh)),this.lastMesh=p;const f=r.controls.minDistance,x=r.controls.maxDistance;r.fitCamera([p]),r.controls.minDistance=f,r.controls.maxDistance=x;const v=document.querySelector("#status"),m=document.querySelector("#map-link");v.innerText="",m.href="",m.textContent=""}geoFindMe(){const t=this.gameObject,e=document.querySelector("#status"),s=document.querySelector("#map-link");if(!e||!s)return;s.href="",s.textContent="";let i=!1;function o(n){return new Date(n).toLocaleTimeString()}function r(n){var p,f;const h=n.coords.latitude,l=n.coords.longitude;e.textContent="",s.href=`https://www.openstreetmap.org/#map=18/${h}/${l}`,s.innerHTML=`Latitude: ${h}°<br/>Longitude: ${l}°`,e.innerText=`Timestamp: ${o(n.timestamp)}
Accuracy: ${(p=n.coords.accuracy)==null?void 0:p.toFixed(2)}m
Altitude: ${n.coords.altitude}, Altitude Accuracy: ${(f=n.coords.altitudeAccuracy)==null?void 0:f.toFixed(2)}
Heading: ${n.coords.heading}`;const d=ot(h,l);if(t.position.copy(d),!i){i=!0;const x=at.findObjectOfType(lt);t.scale.set(1e-5,1e-5,1e-5);const v=x.controls.minDistance,m=x.controls.maxDistance;x.fitCamera([t]),x.controls.minDistance=v,x.controls.maxDistance=m}}function a(){e.textContent="Unable to retrieve your location"}if(!navigator.geolocation)e.textContent="Geolocation is not supported by your browser";else{e.textContent="Locating…";const n={enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3};this.currentWatchId!==void 0&&navigator.geolocation.clearWatch(this.currentWatchId),this.currentWatchId=navigator.geolocation.watchPosition(r,a,n)}}onBeforeRender(){const t=this.context.mainCameraComponent;this.cameraWp.copy(t.worldPosition),Et(this.gameObject,this.objectWp);const e=this.cameraWp.distanceTo(this.objectWp),s=e*.01;this.gameObject.scale.set(s,s,s),t.nearClipPlane=1e-4*e,t.farClipPlane=1e3*e}}mt.add("MapLocator",Ct);mt.add("DisplayMap",Lt);
